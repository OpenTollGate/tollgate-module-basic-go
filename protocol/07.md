# TIP-07 - Remote Control
`draft` `optional` `kind=21024` `kind=21025`

---

> **Note on device_id**: The `device_id` field is currently optional but should be considered for removal in a future version of this specification. Since each TollGate has a unique pubkey, device_id is redundant for most deployments. It's only useful in fleet management scenarios where one keypair controls multiple physical devices, which is uncommon and creates security concerns (single key compromise = fleet compromise).

## Overview

Remote Control enables authorized operators to send commands to TollGate devices via Nostr events and receive signed responses. This facilitates remote management, diagnostics, and maintenance operations.

## Security Model

- Commands MUST be signed by an authorized controller pubkey
- TollGates MUST maintain an allowlist of authorized controller pubkeys
- Commands MUST include a unique nonce to prevent replay attacks
- TollGates MUST reject commands older than 5 minutes
- TollGates MUST maintain a ledger of executed command event IDs
- Sensitive commands (e.g., reboot) MUST implement rate limiting

## Command Event

Controllers send commands to TollGates using `kind=21024` events:

```json
{
    "kind": 21024,
    "pubkey": "<controller_pubkey>",
    "created_at": 1731294000,
    "tags": [
        ["p", "<tollgate_pubkey>"],
        ["cmd", "<command_name>"],
        ["nonce", "<unique_nonce>"],
        ["device_id", "<device_identifier>"]
    ],
    "content": "{\"args\":{}}",
    // ...
}
```

### Tags

#### Required Tags
- `p`: Target TollGate pubkey (from TollGate Discovery event)
- `cmd`: Command name (e.g., `uptime`, `reboot`, `status`)
- `nonce`: Unique identifier for replay protection

#### Optional Tags
- `device_id`: Device identifier (only for fleet management scenarios, consider removing)
- Additional tags may be defined per command

### Content
JSON-encoded object containing command-specific arguments. Empty object `{}` for commands without arguments.

## Response Event

TollGates respond with `kind=21025` events:

```json
{
    "kind": 21025,
    "pubkey": "<tollgate_pubkey>",
    "created_at": 1731294012,
    "tags": [
        ["p", "<controller_pubkey>"],
        ["cmd", "<command_name>"],
        ["in_reply_to", "<command_event_id>"],
        ["device_id", "<device_identifier>"],
        ["status", "<ok|error>"]
    ],
    "content": "{\"uptime_sec\":12345,\"timestamp\":1731294012}",
    // ...
}
```

### Tags

#### Required Tags
- `p`: Controller pubkey (from the command event)
- `cmd`: Original command name
- `in_reply_to`: Event ID of the command being responded to
- `device_id`: Device identifier
- `status`: Result status (`ok` or `error`)

#### Optional Tags
- Command-specific result tags

### Content
JSON-encoded object containing command results or error information.

## Standard Commands

### `uptime`
Query system uptime and basic status.

**Command:**
```json
{
    "kind": 21024,
    "pubkey": "3bf0c63fcb93463407af97a5e5ee64fa883d107ef9e558472c4eb9aaaefa459d",
    "created_at": 1731294000,
    "tags": [
        ["cmd", "uptime"],
        ["p", "e7c0a6e2f2e4b8c9d1a3f5e7b9c1d3e5f7a9b1c3d5e7f9a1b3c5d7e9f1a3b5c7"],
        ["nonce", "abc123def456"],
        ["device_id", "router-01"]
    ],
    "content": "{}",
    "id": "d1c3e5f7a9b1c3d5e7f9a1b3c5d7e9f1a3b5c7d9e1f3a5b7c9d1e3f5a7b9c1d3",
    "sig": "..."
}
```

**Response:**
```json
{
    "kind": 21025,
    "pubkey": "e7c0a6e2f2e4b8c9d1a3f5e7b9c1d3e5f7a9b1c3d5e7f9a1b3c5d7e9f1a3b5c7",
    "created_at": 1731294012,
    "tags": [
        ["cmd", "uptime"],
        ["p", "3bf0c63fcb93463407af97a5e5ee64fa883d107ef9e558472c4eb9aaaefa459d"],
        ["in_reply_to", "d1c3e5f7a9b1c3d5e7f9a1b3c5d7e9f1a3b5c7d9e1f3a5b7c9d1e3f5a7b9c1d3"],
        ["device_id", "router-01"],
        ["status", "ok"]
    ],
    "content": "{\"status\":\"ok\",\"timestamp\":1731294012,\"data\":{\"uptime_sec\":86400,\"load_avg\":[\"0.5\",\"0.6\",\"0.7\"]}}",
    "id": "a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2",
    "sig": "..."
}
```

### `reboot`
Initiate a controlled system reboot.

**Success Criteria**: Command succeeds when reboot is scheduled (within 60 seconds). No tracking of actual reboot execution or post-reboot confirmation needed.

**Command:**
```json
{
    "kind": 21024,
    "pubkey": "3bf0c63fcb93463407af97a5e5ee64fa883d107ef9e558472c4eb9aaaefa459d",
    "created_at": 1731294100,
    "tags": [
        ["cmd", "reboot"],
        ["p", "e7c0a6e2f2e4b8c9d1a3f5e7b9c1d3e5f7a9b1c3d5e7f9a1b3c5d7e9f1a3b5c7"],
        ["nonce", "xyz789ghi012"],
        ["device_id", "router-01"]
    ],
    "content": "{\"delay_sec\":60}",
    "id": "f3e5d7c9b1a3f5e7d9c1b3a5f7e9d1c3b5a7f9e1d3c5b7a9f1e3d5c7b9a1f3e5",
    "sig": "..."
}
```

**Response:**
```json
{
    "kind": 21025,
    "pubkey": "e7c0a6e2f2e4b8c9d1a3f5e7b9c1d3e5f7a9b1c3d5e7f9a1b3c5d7e9f1a3b5c7",
    "created_at": 1731294105,
    "tags": [
        ["cmd", "reboot"],
        ["p", "3bf0c63fcb93463407af97a5e5ee64fa883d107ef9e558472c4eb9aaaefa459d"],
        ["in_reply_to", "f3e5d7c9b1a3f5e7d9c1b3a5f7e9d1c3b5a7f9e1d3c5b7a9f1e3d5c7b9a1f3e5"],
        ["device_id", "router-01"],
        ["status", "ok"]
    ],
    "content": "{\"status\":\"ok\",\"timestamp\":1731294105,\"message\":\"Reboot scheduled in 60 seconds\",\"data\":{\"delay_sec\":60}}",
    "id": "c5a7b9d1e3f5a7b9c1d3e5f7a9b1c3d5e7f9a1b3c5d7e9f1a3b5c7d9e1f3a5b7",
    "sig": "..."
}
```

### `status`
Query comprehensive device status.

**Command:**
```json
{
    "kind": 21024,
    "tags": [
        ["cmd", "status"],
        ["p", "<tollgate_pubkey>"],
        ["nonce", "def456"],
        ["device_id", "router-01"]
    ],
    "content": "{}",
    // ...
}
```

**Response:**
```json
{
    "kind": 21025,
    "tags": [
        ["cmd", "status"],
        ["p", "<controller_pubkey>"],
        ["in_reply_to", "<command_event_id>"],
        ["device_id", "router-01"],
        ["status", "ok"]
    ],
    "content": "{\"version\":\"0.0.4\",\"uptime_sec\":86400,\"active_sessions\":3,\"upstream_connected\":true,\"memory_free_mb\":128}",
    // ...
}
```

## Implementation Requirements

### TollGate MUST:
1. Maintain a configuration section for remote control:
   ```json
   {
       "control": {
           "enabled": true,
           "allowed_pubkeys": ["<controller_pubkey_1>", "..."],
           "device_id": "router-01",
           "reboot_min_interval_sec": 600
       }
   }
   ```

2. Subscribe to `kind=21024` events where `p` tag matches its pubkey

3. Validate each command:
   - Verify event signature
   - Check sender pubkey is in `allowed_pubkeys`
   - Verify `created_at` is within 5 minutes of current time
   - Check event ID not in executed commands ledger
   - Validate nonce is unique

4. Store executed event IDs in persistent storage:
   ```json
   {
       "executed_commands": [
           {"event_id": "...", "timestamp": 1731294000},
           {"event_id": "...", "timestamp": 1731294100}
       ],
       "last_reboot": 1731290000
   }
   ```

5. Rate limit sensitive operations:
   - Reboot: minimum 10 minutes between reboots
   - Other command-specific limits as appropriate

6. Publish response events to configured relays

7. Log all command executions for audit trail

### Controllers SHOULD:
1. Use unique nonces for each command
2. Set reasonable timeouts for command responses
3. Handle missing or delayed responses gracefully
4. Respect rate limits and avoid command spam

## Error Responses

When a command fails, the response MUST include `["status", "error"]` tag and error details in content:

```json
{
    "kind": 21025,
    "tags": [
        ["cmd", "reboot"],
        ["status", "error"],
        ["in_reply_to", "<command_event_id>"],
        ["p", "<controller_pubkey>"],
        ["device_id", "router-01"]
    ],
    "content": "{\"error\":\"reboot_too_soon\",\"message\":\"Last reboot was 300 seconds ago, minimum interval is 600 seconds\"}",
    // ...
}
```

### Standard Error Codes
- `unauthorized`: Sender not in allowed_pubkeys
- `replay_detected`: Event ID already executed
- `expired`: Command too old
- `invalid_command`: Unknown command name
- `reboot_too_soon`: Reboot rate limit exceeded
- `execution_failed`: Command execution failed

## Privacy Considerations

This TIP uses unencrypted events for simplicity. Implementations MAY use TIP-05 (Encrypted Events) to:
- Hide command details from relay operators
- Prevent command observation by third parties
- Protect response data

When using encryption, the event structure remains the same but `content` is encrypted per TIP-05 specification.

## Future Extensions

- Multi-signature approval for critical commands
- Scheduled/delayed command execution
- Command batching and chaining
- File upload/download commands
- Configuration update commands (e.g., `set_price`, `update_config`)
- Diagnostic data collection commands
- Arbitrary command execution (e.g., `exec` with shell commands)
- Service management (e.g., `restart_service`, `reload_config`)

**Note**: `uptime`, `reboot`, and `status` are reference implementations. The protocol is designed to be extensible - implementations can add custom commands as needed for their use cases.
