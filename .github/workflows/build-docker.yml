name: Build and Publish

on:
  push:

## Add global env vars for the whole workflow
env:
  PACKAGE_NAME: "tollgate-module-basic-go"

jobs:
  determine-versioning:
    runs-on: ubuntu-latest
    outputs:
      package_version: ${{ steps.determine-package-version.outputs.package_version }}
      release_channel: ${{ steps.determine-release-channel.outputs.release_channel }}
    steps:
      - id: commit-hash
        uses: prompt/actions-commit-hash@v3

      - name: Set package_version variable
        id: determine-package-version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # If this is a tag push, use the tag name
            echo "package_version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          else
            # If this is a branch push, use branch-shortCommitHash format
            echo "package_version=${GITHUB_REF_NAME}-${{ steps.commit-hash.outputs.short }}" >> $GITHUB_OUTPUT
          fi
        
      - name: Set version variable
        id: determine-release-channel
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "release_channel=stable" >> $GITHUB_OUTPUT
          else
            echo "release_channel=dev" >> $GITHUB_OUTPUT
          fi

  build-package:
    needs: determine-versioning
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # - architecture: amd64
          #   goarch: amd64
          #   sdk: x86-64
          # - architecture: arm_cortex-a7
          #   goarch: arm
          #   goarm: 7
          #   sdk: arm_cortex-a7
          - architecture: arm64_cortex-a53
            goarch: arm64
            sdk: mediatek-filogic
          # - architecture: mipsel_24kc
          #   goarch: mipsle
          #   gomips: softfloat
          #   sdk: mipsel_24kc
          # - architecture: mips_24kc
          #   goarch: mips
          #   gomips: softfloat
          #   sdk: mips_24kc
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Build Package using custom action
        uses: ./actions/build-package.yml
        with:
          architecture: ${{ matrix.architecture }}
          sdk: ${{ matrix.sdk }}
          openwrt_version: '23.05.3'
          package_version: ${{ needs.determine-versioning.outputs.package_version }}
          release_channel: ${{ needs.determine-versioning.outputs.release_channel }}
          nostr_secret_key: ${{ secrets.NOSTR_SECRET_KEY }}
          nostr_public_key: ${{ secrets.NOSTR_PUBLIC_KEY }}
          nostr_relays: 'wss://relay.damus.io,wss://nos.lol,wss://nostr.mom'
          nsecbech: ${{ secrets.NSECBECH }}
          nsec: ${{ secrets.NSEC_HEX }}
          # Pass arch-specific environment variables
          GOARCH: ${{ matrix.goarch }}
          GOMIPS: ${{ matrix.gomips }}
          GOARM: ${{ matrix.goarm }}

      - name: Trigger OS Workflow
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: OpenTollGate/tollgate-os
          event-type: update-release-json