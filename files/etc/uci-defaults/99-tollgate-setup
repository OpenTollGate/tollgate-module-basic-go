#!/bin/sh

# Function to log messages
log_message() {
    logger -t tollgate-setup "$1"
    echo "$1"
}

log_message "Starting 99-tollgate-setup script..."

# Helper function to safely set UCI values
uci_safe_set() {
    local config="$1"
    local section="$2"
    local option="$3"
    local value="$4"
    uci set "$config.$section.$option=$value"
}

# Helper function to safely delete UCI sections
uci_safe_delete() {
    local config="$1"
    local section="$2"
    if uci -q get "$config.$section" >/dev/null 2>&1; then
        uci delete "$config.$section"
    fi
}

# --- Derive Private Network Configuration ---

log_message "Deriving private network configuration..."

# Get the random suffix from the public SSID
PUBLIC_SSID_2G=$(uci -q get wireless.default_radio0.ssid)
if [ -z "$PUBLIC_SSID_2G" ]; then
    log_message "Error: Could not get public 2.4GHz SSID. Exiting."
    exit 1
fi
RANDOM_SUFFIX=$(echo "$PUBLIC_SSID_2G" | awk -F'-' '{print $2}')
if [ -z "$RANDOM_SUFFIX" ]; then
    log_message "Error: Could not extract random suffix from SSID: $PUBLIC_SSID_2G. Exiting."
    exit 1
fi
log_message "Random suffix is: $RANDOM_SUFFIX"

# Get the LAN IP to derive the private IP
LAN_IP=$(uci -q get network.lan.ipaddr)
if [ -z "$LAN_IP" ]; then
    log_message "Error: Could not get LAN IP address. Exiting."
    exit 1
fi
OCTET1=$(echo "$LAN_IP" | cut -d'.' -f1)
OCTET2=$(echo "$LAN_IP" | cut -d'.' -f2)
OCTET3=$(echo "$LAN_IP" | cut -d'.' -f3)

if [ "$OCTET3" -eq 255 ]; then
    PRIVATE_OCTET3=$((OCTET3 - 1))
else
    PRIVATE_OCTET3=$((OCTET3 + 1))
fi

PRIVATE_IP="${OCTET1}.${OCTET2}.${PRIVATE_OCTET3}.1"
log_message "Private IP will be: $PRIVATE_IP"

PRIVATE_SSID_2G="c03rad0r-${RANDOM_SUFFIX}-2.4GHz"
PRIVATE_SSID_5G="c03rad0r-${RANDOM_SUFFIX}-5GHz"
PRIVATE_KEY="securepassword123"

# --- Network Configuration ---
log_message "Configuring private network interface and bridge..."
uci_safe_set network private interface
uci_safe_set network private proto 'static'
uci_safe_set network private device 'br-private'
uci_safe_set network private ipaddr "$PRIVATE_IP"
uci_safe_set network private netmask '255.255.255.0'

uci_safe_set network private_bridge device
uci_safe_set network private_bridge type 'bridge'
uci_safe_set network private_bridge name 'br-private'

# --- DHCP Configuration ---
log_message "Configuring DHCP for private network..."
uci_safe_set dhcp private dhcp
uci_safe_set dhcp private interface 'private'
uci_safe_set dhcp private start '100'
uci_safe_set dhcp private limit '150'
uci_safe_set dhcp private leasetime '12h'

# --- Wireless Configuration ---
log_message "Configuring private wireless interfaces..."
uci_safe_set wireless wifinet0 wifi-iface
uci_safe_set wireless wifinet0 device 'radio0'
uci_safe_set wireless wifinet0 network 'private'
uci_safe_set wireless wifinet0 mode 'ap'
uci_safe_set wireless wifinet0 ssid "$PRIVATE_SSID_2G"
uci_safe_set wireless wifinet0 encryption 'psk2+ccmp'
uci_safe_set wireless wifinet0 key "$PRIVATE_KEY"
uci_safe_set wireless wifinet0 disabled '0'

uci_safe_set wireless wifinet1 wifi-iface
uci_safe_set wireless wifinet1 device 'radio1'
uci_safe_set wireless wifinet1 network 'private'
uci_safe_set wireless wifinet1 mode 'ap'
uci_safe_set wireless wifinet1 ssid "$PRIVATE_SSID_5G"
uci_safe_set wireless wifinet1 encryption 'psk2+ccmp'
uci_safe_set wireless wifinet1 key "$PRIVATE_KEY"
uci_safe_set wireless wifinet1 disabled '0'

# --- Firewall Configuration ---
log_message "Configuring firewall for private network..."
uci_safe_set firewall private_zone zone
uci_safe_set firewall private_zone name 'private'
uci_safe_set firewall private_zone network 'private'
uci_safe_set firewall private_zone input 'ACCEPT'
uci_safe_set firewall private_zone output 'ACCEPT'
uci_safe_set firewall private_zone forward 'ACCEPT'

uci_safe_set firewall private_forwarding forwarding
uci_safe_set firewall private_forwarding src 'private'
uci_safe_set firewall private_forwarding dest 'wan'

# --- Fix Firewall Includes and Add TollGate Rules ---
log_message "Fixing firewall includes and adding TollGate rules..."
# This is to remove the include that points to the non-existent file
uci_safe_delete firewall tollgate_rules

# Add the TollGate rules directly
uci_safe_set firewall tollgate_in rule
uci_safe_set firewall tollgate_in name 'Allow-TollGate-In'
uci_safe_set firewall tollgate_in src 'lan'
uci_safe_set firewall tollgate_in proto 'tcp'
uci_safe_set firewall tollgate_in dest_port '2121'
uci_safe_set firewall tollgate_in target 'ACCEPT'

uci_safe_set firewall relay_in rule
uci_safe_set firewall relay_in name 'Allow-Relay-In'
uci_safe_set firewall relay_in src 'lan'
uci_safe_set firewall relay_in proto 'tcp'
uci_safe_set firewall relay_in dest_port '4242'
uci_safe_set firewall relay_in target 'ACCEPT'

# --- Commit Changes ---
log_message "Committing all changes..."
uci commit network
uci commit dhcp
uci commit wireless
uci commit firewall

log_message "99-tollgate-setup script finished."

exit 0
